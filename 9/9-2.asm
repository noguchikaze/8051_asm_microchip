ORG	00H
JMP		PRE
ORG	50H

PRE:
;	MOV	DPTR,#TABLE
	KEY	EQU	P2
	MOTOR	EQU	P1
	C1	EQU		R0
	C2	EQU		R1
	ROWCOUNTER		EQU		R2
	ROWINDEX1		EQU	31H
	ROWINDEX2		EQU	30H
	SCAN	EQU		R3

	MOV	C1,#0
	MOV	C2,#0
	MOV	B,#00010001B	;給步進馬達的

INIT:
	MOV	R4,#01111111B	;給鍵盤掃描的
	MOV	ROWCOUNTER,#0
	MOV	ROWINDEX1,#0
	MOV	ROWINDEX2,#0
	MOV	SCAN,#0

START:
	MOV	KEY,R4
	CALL	KDELAY
	MOV	A,KEY
	ANL		A,#00001111B
	CJNE	A,#00001111B,JUDGE
NOBUTTON:
	INC	ROWCOUNTER

	MOV	A,R4
	RR	A
	MOV	R4,A

	MOV	A,ROWINDEX1
	ADD		A,#4
	MOV	ROWINDEX1,A

	CJNE	ROWCOUNTER,#4,START
	JMP	INIT
;================有按鍵被按下=======================
JUDGE:
COL1:
	CJNE	A,#00001110B,COL2
	MOV	ROWINDEX2,#0
	CALL	ADDINDEX
	CALL	ACTION
	JMP		START
COL2:
	CJNE	A,#00001101B,COL3
	MOV	ROWINDEX2,#1
	CALL	ADDINDEX
	CALL	ACTION
	JMP		START
COL3:
	CJNE	A,#00001011B,COL4
	MOV	ROWINDEX2,#2
	CALL	ADDINDEX
	CALL	ACTION
	JMP		START
COL4:
	CJNE	A,#00000111B,NOBUTTON
	MOV	ROWINDEX2,#3
	CALL	ADDINDEX
	CALL	ACTION
	JMP		START
;======================================
ADDINDEX:
	MOV	A,ROWINDEX1
	ADD		A,ROWINDEX2
	MOV	R7,A
	RET

ACTION:
	MOV	A,#00010001B
KEY0:	;RR	90
	CJNE	R7,#0,KEY1
	K0:
		MOV	MOTOR,A
		RR	A
		CALL	MDELAY
		INC	C1
		CJNE	C1,#130,K0
		RET
KEY1:	;RR	180
	CJNE	R7,#1,KEY2
	K1:
		MOV	MOTOR,A
		RR	A
		CALL	MDELAY
		INC	C1
		CJNE	C1,#130,K1
		MOV	C1,#0
		INC	C2
		CJNE	C2,#2,K1
		MOV	C1,#0
		MOV	C2,#0
		RET
KEY2:	;RR 270
	CJNE	R7,#2,KEY3
	K2:
		MOV	MOTOR,A
		RR	A
		CALL	MDELAY
		INC	C1
		CJNE	C1,#130,K2
		MOV	C1,#0
		INC	C2
		CJNE	C2,#3,K2
		MOV	C1,#0
		MOV	C2,#0
	RET
KEY3:	;RR	360
	CJNE	R7,#3,KEY4
	K3:
		MOV	MOTOR,A
		RR	A
		CALL	MDELAY
		INC	C1
		CJNE	C1,#130,K3
		MOV	C1,#0
		INC	C2
		CJNE	C2,#4,K3
		MOV	C1,#0
		MOV	C2,#0
	RET
KEY4:	;RL	90
	CJNE	R7,#4,KEY5
	K4:
		MOV	MOTOR,A
		RL		A
		CALL	MDELAY
		INC	C1
		CJNE	C1,#130,K4
		MOV	C1,#0
	RET
KEY5:	;RL180
	CJNE	R7,#5,KEY6
	K5:
		MOV	MOTOR,A
		RL		A
		CALL	MDELAY
		INC	C1
		CJNE	C1,#130,K5
		MOV	C1,#0
		INC	C2
		CJNE	C2,#2,K5
		MOV	C1,#0
		MOV	C2,#0
	RET
KEY6:	;RL270
	CJNE	R7,#6,KEY7
	K6:
		MOV	MOTOR,A
		RL 	A
		CALL	MDELAY
		INC	C1
		CJNE	C1,#130,K6
		MOV	C1,#0
		INC	C2
		CJNE	C2,#3,K6
		MOV	C1,#0
		MOV	C2,#0
	RET
KEY7:
	CJNE	R7,#7,INTENR
	K7:
		MOV	MOTOR,A
		RL 	A
		CALL	MDELAY
		INC	C1
		CJNE	C1,#130,K7
		MOV	C1,#0
		INC	C2
		CJNE	C2,#4,K7
		MOV	C1,#0
		MOV	C2,#0
INTENR:
	RET
;=============給不同東西用的DELAY============
KDELAY:
	MOV	R5,#1FH
K:
	MOV	R6,#1FH
	DJNZ	R6,$
	DJNZ	R5,K
	RET

MDELAY:
	MOV	R5,#0FFH
M:
	MOV	R6,#75
	DJNZ	R6,$
	DJNZ	R5,M
	RET

END
