ORG	00H
JMP	PRE
ORG	50H

;P1=KEY
;P0
PRE:
	MOV	DPTR,#TABLE
START:
	MOV	R0,#01111111B
	MOV	R1,#0	;ROW COUNTER
	MOV	R2,#0	;INDEX FOR ROW
	MOV	R4,#0	;掃描七段
ROW:

	MOV	P1,R0		;CHECK ROW
	CALL	DELAY
	MOV	A,P1
	ANL	A,#00001111B	;CHECK IF KEY IS PRESSED

	INC	R1		;ROW COUNTER++

	CJNE	A,#00001111B,COL1

;=========在沒有按鍵按下的情況==============================

	MOV	A,R0	;準備掃描下一列
	RR	A
	MOV	R0,A

	MOV	A,R2
	ADD	A,#4		;INDEX FOR ROW +4
	MOV	R2,A

	CJNE	R1,#4,ROW
;==========掃完每一列以後===================================
SHOW:
	MOV	A,R7
	MOVC	A,@A+DPTR
	MOV	P2,A
	CALL	DELAY
	CJNE	R3,#1,START
;========如果上一個有十位數=======
	INC	R4
	MOV	P2,#11100001B
	CALL	DELAY
	CJNE	R4,#01FH,SHOW	
	JMP	START	;從頭開始掃描	

;==========按鍵有被按下的情況==============================
;==========掃描完後,A有四種狀況: 0111 1011 1101 1110==============

COL1:
	CJNE	A,#00001110B,COL2
	MOV	R3,#0	;FOR INDEX
	JMP	NADD
COL2:
	CJNE	A,#00001101B,COL3
	MOV	R3,#1	;FOR INDEX
	JMP	NADD
COL3:
	CJNE	A,#00001011B,COL4
	MOV	R3,#2	;FOR INDEX
	JMP	NADD
COL4:
	CJNE	A,#00000111B,START
	MOV	R3,#3	;FOR INDEX
	JMP	NADD

NADD:
	MOV	A,R2
	ADD	A,R3
	MOV	R7,A	

;==========判斷是否>9===========================

J10:
	CJNE	A,#10,J11
	MOV	R3,#1	;FLAG
	JMP	START
J11:
	CJNE	A,#11,J12
	MOV	R3,#1	;FLAG
	JMP	START
J12:
	CJNE	A,#12,J13
	MOV	R3,#1	;FLAG
	JMP	START
J13:
	CJNE	A,#13,J14
	MOV	R3,#1	;FLAG
	JMP	START
J14:
	CJNE	A,#14,J15
	MOV	R3,#1	;FLAG
	JMP	START
J15:
	CJNE	A,#15,JS
	MOV	R3,#1	;FLAG
	JMP	START
JS:
	MOVC	A,@A+DPTR
	MOV	P2,A
	CALL	DELAY
	MOV	R3,#0
	JMP	START	


DELAY:
	MOV	R5,#100
DELAY1:
	MOV	R6,#100
DELAY2:
	DJNZ	R6,DELAY2
	DJNZ	R5,DELAY1
	RET
;===================TABLE=====================
TABLE:
	DB	11010000B,11010001B,11010010B,11010011B
	DB	11010100B,11010101B,11010110B,11010111B
	DB	11011000B,11011001B,11010000B,11010001B
	DB	11010010B,11010011B,11010100B,11010101B